workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH != "main" && $CI_PIPELINE_SOURCE != "merge_request_event"'
      when: never
    - when: always
stages:
  - testing
  - build_images
  - push_image
  - deploy

run_int_tests:
  stage: testing
  before_script:
    - echo 'Preparing int test data'
  script:
    - echo 'Running tests...'
  after_script:
    - echo 'Cleaning the temp files'

run_unit_tests:
  stage: testing
  before_script:
    - echo 'Preparing unit test data'
  script:
    - echo 'Running tests...'
  after_script:
    - echo 'Cleaning the temp files'

build_images:
  only:
    - main
  stage: build_images
  script:
    - echo 'Building the docker image'
    - echo 'Tagging the docker image'

push_image:
  only:
    - main
  stage: build_images
  needs:
     - build_images
  script:
    - echo 'Logging into docker image'
    - echo 'Pushing image to docker registry'

deploy_image:
   only:
     - main
   stage: deploy
   script:
      - echo 'image successfully deployed to dev server'